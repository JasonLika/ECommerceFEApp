@page "/products"
@using ECommerceFEApp.Services; 
@using ECommerceFEApp.Models;
@inject ProductService ProductService
@inject NavigationManager Navigation;

<h3>Products</h3>
 
<div class="filters mb-3">
    <input @bind="NameFilter" class="form-control form-control-sm" placeholder="Search name..." style="width: 300px; display: inline-block; margin-right: 10px;" />
    <input @bind="PriceFilter" class="form-control form-control-sm" placeholder="Filter by price..." style="width: 300px; display: inline-block; margin-right: 10px;" />
    <button @onclick="ApplyFilters" class="btn btn-primary btn-sm" style="margin-right: 10px;">Search</button>
    <button @onclick="ClearFilters" class="btn btn-secondary btn-sm">Clear Filters</button>
</div>

<table class="table">
<thead>
<tr>
<th>ID</th>
<th>Image</th>
<th>Name</th>
<th>Description</th>
<th>Price</th>
<th>Stock</th>
<th>Size</th>
</tr>
</thead>
<tbody>
    @foreach (var product in FilteredProducts)
    {
<tr>
<td>@product.Id</td>
<td>
    @if (!string.IsNullOrEmpty(product.ImageUrl))
    {
        <img src="@product.ImageUrl" style="width:50px;" alt="Thumbnail" />
    }
</td>
<td>
    <a href="/product-details/@product.Id">@product.Name</a>
</td>
<td>@product.Description</td>
<td>@product.Price</td>
<td>@product.Stock</td>
<td>@product.Size</td>
<td>
<button class="btn btn-warning" @onclick="() => NavigateToReview(product.Id)">Reviews</button>
<button class="btn btn-warning" @onclick="() => NavigateToUpdate(product.Id)">Edit</button>
<button class="btn btn-danger" @onclick="() => DeleteProduct(product.Id)">Delete</button>
</td>
</tr>
    }
</tbody>
</table>

@code {
    /*
    private List<Product> ProductList = new();
 
    protected override async Task OnInitializedAsync()
    {
        ProductList = await ProductService.GetProductsAsync();
    }

    private void NavigateToReview(int id) {
        Navigation.NavigateTo($"/reviews/{id}");
    }

    private void NavigateToUpdate(int id) {
        Navigation.NavigateTo($"/update-product/{id}");
    }

    private async Task DeleteProduct(int id) {
        await ProductService.DeleteProductAsync(id);
        ProductList = await ProductService.GetProductsAsync();
    }
    */

    @code {
    private List<Product> ProductList = new(); // Original product list
    private List<Product> FilteredProducts = new(); // Filtered product list
    
    private string NameFilter { get; set; } = string.Empty; // Search term for the product name
    private string PriceFilter { get; set; } = string.Empty; // Filter by price

    protected override async Task OnInitializedAsync()
    {
        ProductList = await ProductService.GetProductsAsync(); // Fetch products from the service
        FilteredProducts = ProductList; // Initialize the filtered list
    }

    private void ApplyFilters()
    {
        // Apply search and price filters
        FilteredProducts = ProductList.Where(product => 
            (string.IsNullOrEmpty(NameFilter) || product.Name.Contains(NameFilter, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(PriceFilter) || product.Price.ToString().Contains(PriceFilter))
        ).ToList();
    }

    private void ClearFilters()
    {
        // Clear the filters and reset the filtered list
        NameFilter = string.Empty;
        PriceFilter = string.Empty;
        FilteredProducts = ProductList; // Reset to the full product list
    }

    private void NavigateToReview(int id)
    {
        Navigation.NavigateTo($"/reviews/{id}"); // Redirect to reviews page
    }

    private void NavigateToUpdate(int id)
    {
        Navigation.NavigateTo($"/update-product/{id}"); // Redirect to update page
    }

    private async Task DeleteProduct(int id)
    {
        await ProductService.DeleteProductAsync(id); // Delete the product
        ProductList = await ProductService.GetProductsAsync(); // Refresh the product list
        FilteredProducts = ProductList; // Reset the filtered list
    }
}

}